<?xml version='1.0' encoding='utf-8' standalone='no'?>
<!DOCTYPE issue SYSTEM "lwg-issue.dtd">

<issue num="4213" status="New">
<title>Sender spec depends on unspecified order of evaluation</title>
<section>
<sref ref="[exec.snd]"/>
</section>
<submitter>Frank Birbacher</submitter>
<date>14 Feb 2025</date>
<priority>2</priority>

<discussion>
<p>
In certain clauses for defining senders the unspecified order of evaluation of function arguments can 
lead to retrieving values from a move-from state of a sender. An example is <sref ref="[exec.continues.on]"/> 
where paragraph 3 states:
</p>
<blockquote><pre>
transform_sender(<i>get-domain-early</i>(sndr), <i>make-sender</i>(continues_on, sch, sndr))
</pre></blockquote>
<p>
In this expression the evaluation of <tt><i>get-domain-early</i>(sndr)</tt> can happen before or after 
the <tt><i>make-sender</i></tt>. The latter can steal the value from `sndr` by moving from it. So 
<tt><i>get-domain-early</i></tt> may see the moved-from state of `sndr` and fail to obtain anything.
<p/>
Repetitions are at least in:
</p>
<ol>
<li><p><sref ref="[exec.then]"/> p3</p></li>
<li><p><sref ref="[exec.let]"/> p4</p></li>
<li><p><sref ref="[exec.bulk]"/> p2</p></li>
<li><p><sref ref="[exec.split]"/> p4</p></li>
<li><p><sref ref="[exec.when.all]"/> p3</p></li>
<li><p><sref ref="[exec.into.variant]"/> p3</p></li>
<li><p><sref ref="[exec.stopped.opt]"/> p2</p></li>
<li><p><sref ref="[exec.stopped.err]"/> p2</p></li>
<li><p><sref ref="[exec.sync.wait.var]"/> p1</p></li>
</ol>

<note>2025-10-23; Reflector poll.</note>
<p>
Set priority to 2 after reflector poll.
</p>
<p>
"Don't want to have to consider whether you can call `get_env` on a moved-from sender.
If the domain is a stateless tag type, then <i>get-domain-early</i>'s return value
can't depend on the actual value of the sender, just its type.
If that's correct, we can just spell this `decltype(get-domain-early(sndr)){}`.
We already do this for <i>get-domain-late</i>."
</p>
<p>
"The point of all these exposition-only things was to make the wording more compact and readable.
Adding `decltype` and parens everywhere wouldn't help that.
Maybe change <i>get-domain-early</i> and <i>get-domain-late</i> from function templates
to all-caps wording macros, e.g. <i>`GET-DOMAIN-EARLY`</i>`(sndr)`?"
</p>
<p>
"NAD, I think the issue is covered by “except sndr is evaluated just once.”"
</p>
</discussion>

<resolution>
</resolution>

</issue>
